<!DOCTYPE html>
<!-- NOOR v5.0 â€” REAL-TIME QURAN + HADITH â€” GEMINI-POWERED SEARCH -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="theme-color" content="#071818">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Noor">
<title>Noor â€” Ù†ÙˆØ±</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸŒ™</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --gold:#c9a84c;--gold2:#a8722a;--gs:rgba(201,168,76,0.13);
  --bg:#071818;--text:rgba(253,246,227,0.9);--text2:rgba(253,246,227,0.55);--text3:rgba(253,246,227,0.25);
  --border:rgba(201,168,76,0.2);--border2:rgba(201,168,76,0.1);--card:rgba(255,255,255,0.04);--r:16px;
}
body{font-family:Inter,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overscroll-behavior:none}
::-webkit-scrollbar{width:0}
button{cursor:pointer;font-family:Inter,sans-serif}
input,textarea{font-family:Inter,sans-serif;outline:none;-webkit-appearance:none}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{box-shadow:0 0 18px rgba(201,168,76,0.35)}50%{box-shadow:0 0 32px rgba(201,168,76,0.65)}}
@keyframes glow{0%,100%{opacity:.5}50%{opacity:1}}
.fade{animation:fadeUp .3s ease both}

/* â”€â”€ SETUP SCREEN â”€â”€ */
#setup{position:fixed;inset:0;background:linear-gradient(160deg,#030e0e,#071818,#040f0f);
  display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;z-index:999}
.setup-box{max-width:440px;width:100%;text-align:center}
.setup-moon{font-size:5rem;filter:drop-shadow(0 0 30px rgba(201,168,76,.9));margin-bottom:20px;animation:glow 3s ease infinite}
.setup-title{font-family:Amiri,serif;font-size:2.2rem;color:var(--gold);margin-bottom:6px}
.setup-arabic{font-family:Amiri,serif;font-size:1.4rem;color:rgba(201,168,76,.3);margin-bottom:20px}
.setup-why{background:rgba(201,168,76,.07);border:1px solid rgba(201,168,76,.2);border-radius:14px;
  padding:16px;margin-bottom:20px;text-align:left}
.setup-why h3{font-size:.75rem;color:var(--gold);text-transform:uppercase;letter-spacing:2px;margin-bottom:10px}
.setup-why li{font-size:.83rem;color:var(--text2);line-height:1.8;margin-left:14px}
.setup-input{width:100%;background:rgba(255,255,255,.06);border:2px solid rgba(201,168,76,.3);
  border-radius:12px;padding:13px 15px;color:var(--text);font-size:.95rem;margin-bottom:10px;
  text-align:center;letter-spacing:.5px}
.setup-input:focus{border-color:var(--gold)}
.setup-btn{width:100%;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;
  border-radius:12px;padding:14px;color:#1a1208;font-weight:700;font-size:1rem;margin-bottom:10px}
.setup-skip{background:none;border:none;color:var(--text3);font-size:.8rem;padding:8px}
.setup-link{color:var(--gold);text-decoration:none;font-weight:600}

/* â”€â”€ APP â”€â”€ */
#app{display:none;flex-direction:column;min-height:100vh}
#app.show{display:flex}
.header{padding:max(18px,env(safe-area-inset-top)) 16px 12px;
  background:rgba(7,24,24,.95);backdrop-filter:blur(14px);
  border-bottom:1px solid var(--border2);position:sticky;top:0;z-index:100}
.h-row{display:flex;align-items:center;justify-content:space-between}
.h-logo{display:flex;align-items:center;gap:10px}
.h-moon{font-size:1.5rem;filter:drop-shadow(0 0 10px rgba(201,168,76,.7))}
.h-name{font-family:Amiri,serif;font-size:1.8rem;color:var(--gold);letter-spacing:3px;font-style:italic}
.h-arabic{font-family:Amiri,serif;font-size:1.2rem;color:rgba(201,168,76,.3)}
.h-sub{font-size:.55rem;color:var(--text3);letter-spacing:3px;text-transform:uppercase;margin-top:3px;text-align:center}
.h-actions{display:flex;gap:6px}
.hbtn{background:var(--gs);border:1px solid var(--border);border-radius:8px;padding:5px 10px;font-size:.68rem}
.hbtn.key-ok{color:#6fdf8f;border-color:rgba(50,180,80,.3)}
.hbtn.key-no{color:rgba(255,160,80,.8);border-color:rgba(255,160,80,.25)}

.content{flex:1;overflow-y:auto;padding:14px 13px 88px;max-width:760px;margin:0 auto;width:100%}

/* â”€â”€ NAV â”€â”€ */
.nav{position:fixed;bottom:0;left:0;right:0;background:rgba(4,14,14,.98);
  border-top:1px solid var(--border2);backdrop-filter:blur(18px);
  display:flex;justify-content:space-around;
  padding:7px 0 max(10px,env(safe-area-inset-bottom));z-index:100}
.nb{background:none;border:none;display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 8px}
.nb-icon{font-size:1.2rem;transition:filter .2s}
.nb.active .nb-icon{filter:drop-shadow(0 0 8px rgba(201,168,76,.9))}
.nb-label{font-size:.56rem;color:var(--text3)}
.nb.active .nb-label{color:var(--gold)}
.nb-dot{width:4px;height:4px;border-radius:50%;background:transparent;transition:background .2s;margin-top:1px}
.nb.active .nb-dot{background:var(--gold)}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:18px;margin-bottom:14px}
.sl{font-size:.62rem;text-transform:uppercase;letter-spacing:2.5px;color:var(--gold);font-weight:700}
.section-head{background:linear-gradient(135deg,rgba(201,168,76,.1),transparent);
  border-bottom:1px solid var(--border2);padding:11px 16px;margin:-18px -18px 16px;
  border-radius:var(--r) var(--r) 0 0;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}

/* â”€â”€ INPUTS â”€â”€ */
textarea,input[type=text]{background:rgba(255,255,255,.05);border:1.5px solid rgba(201,168,76,.22);
  border-radius:12px;padding:11px 14px;color:var(--text);width:100%;font-size:.92rem;transition:border-color .2s}
textarea:focus,input[type=text]:focus{border-color:var(--gold)}
.sbtn{width:100%;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;
  border-radius:12px;padding:13px;color:#1a1208;font-weight:700;font-size:.9rem;margin-top:10px}
.sbtn:disabled{opacity:.5;cursor:not-allowed}

/* â”€â”€ EMOTIONS â”€â”€ */
.egrid{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:13px;justify-content:center}
.ebtn{background:var(--gs);border:1.5px solid var(--border);color:var(--text2);
  padding:6px 13px;border-radius:50px;font-size:.77rem;transition:all .2s}
.ebtn.on{background:rgba(201,168,76,.2);border-color:var(--gold);color:var(--gold)}

/* â”€â”€ AYAT CARD â”€â”€ */
.acard{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:15px}
.a-meta{background:linear-gradient(135deg,rgba(201,168,76,.12),transparent);
  border-bottom:1px solid var(--border2);padding:10px 15px;
  display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}
.a-ref{font-size:.82rem;color:#e8c97a;font-weight:600}
.a-btns{display:flex;gap:5px}
.abtn{background:var(--gs);border:1px solid var(--border);border-radius:7px;padding:4px 9px;color:rgba(201,168,76,.7);font-size:.72rem}
.abtn.on{background:rgba(201,168,76,.22);color:#e8c97a}
.a-ar{font-family:Amiri,serif;font-size:1.8rem;line-height:2;text-align:right;direction:rtl;
  padding:16px;border-bottom:1px solid var(--border2);background:rgba(201,168,76,.02)}
.a-tr{padding:13px 15px;display:grid;gap:11px}
.tr-row{display:flex;gap:10px;align-items:flex-start}
.lang-badge{min-width:30px;height:30px;background:var(--gs);border:1px solid var(--border);
  border-radius:7px;display:flex;align-items:center;justify-content:center;
  font-size:.58rem;font-weight:800;color:var(--gold);flex-shrink:0}
.lbl{font-size:.56rem;text-transform:uppercase;letter-spacing:2px;color:rgba(201,168,76,.35);margin-bottom:3px}
.ar-txt{font-family:Amiri,serif;direction:rtl;text-align:right;font-size:1rem;line-height:2;color:var(--text2)}
.en-txt{font-size:.91rem;line-height:1.72;color:var(--text2)}
.a-insight{background:linear-gradient(135deg,rgba(10,28,28,.8),rgba(8,22,22,.8));
  border-top:1px solid var(--border2);padding:13px 15px}
.insight-text{font-size:.86rem;line-height:1.8;color:var(--text2)}
.relevance-box{margin-top:9px;padding:9px 12px;background:var(--gs);border-radius:8px;
  border-left:3px solid var(--gold);font-size:.81rem;color:rgba(201,168,76,.8);font-style:italic}

/* â”€â”€ HADITH CARD â”€â”€ */
.hcard{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:15px}
.grade-badge{background:rgba(50,180,80,.12);border:1px solid rgba(50,180,80,.25);
  border-radius:50px;padding:3px 10px;font-size:.63rem;color:#6fdf8f;font-weight:700}
.h-ar{font-family:Amiri,serif;font-size:1.5rem;line-height:1.9;text-align:right;
  direction:rtl;padding:15px;border-bottom:1px solid var(--border2)}
.h-body{padding:13px 15px;display:grid;gap:10px}
.h-exp{background:rgba(10,28,28,.6);border-top:1px solid var(--border2);padding:12px 15px}

/* â”€â”€ LOADER â”€â”€ */
.loader{text-align:center;padding:50px 20px}
.spinner{width:46px;height:46px;border:3px solid var(--border2);
  border-top-color:var(--gold);border-radius:50%;margin:0 auto 14px;animation:spin 1s linear infinite}
.load-arabic{font-family:Amiri,serif;font-size:1.5rem;color:rgba(201,168,76,.2);margin-top:10px;animation:glow 2s ease infinite}
.load-steps{font-size:.72rem;color:var(--text3);margin-top:8px;min-height:18px}

/* â”€â”€ SOURCE TAG â”€â”€ */
.source-tag{display:flex;align-items:center;gap:7px;padding:7px 12px;border-radius:9px;
  font-size:.68rem;margin-bottom:11px;background:rgba(50,180,80,.08);border:1px solid rgba(50,180,80,.2)}
.source-dot{width:7px;height:7px;border-radius:50%;background:#6fdf8f;flex-shrink:0}
.source-offline{background:rgba(201,168,76,.08);border-color:rgba(201,168,76,.2)}
.source-offline .source-dot{background:var(--gold)}

/* â”€â”€ ERROR â”€â”€ */
.err{background:rgba(180,50,50,.09);border:1px solid rgba(180,50,50,.25);
  border-radius:12px;padding:14px;color:rgba(255,180,180,.8);font-size:.87rem;text-align:center;margin-bottom:13px}

/* â”€â”€ EMPTY â”€â”€ */
.empty{text-align:center;padding:60px 16px;color:var(--text3)}

/* â”€â”€ NAMES â”€â”€ */
.ngrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(128px,1fr));gap:8px;margin-top:13px}
.ncard{background:var(--card);border:1px solid var(--border);border-radius:13px;
  padding:12px 9px;text-align:center;cursor:pointer;transition:border-color .2s}
.ncard:hover{border-color:var(--gold)}
.n-detail{background:rgba(201,168,76,.06);border:1px solid var(--gold);border-radius:var(--r);
  padding:22px;text-align:center;margin-bottom:13px}

/* â”€â”€ PRAYER â”€â”€ */
.pr-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-radius:10px;margin-bottom:6px}
.pr-next{background:rgba(201,168,76,.1);border:1px solid var(--border)}
.pr-rest{background:rgba(255,255,255,.02);border:1px solid var(--border2)}

/* â”€â”€ DHIKR â”€â”€ */
.ditem{background:var(--card);border:1.5px solid var(--border2);border-radius:11px;
  padding:9px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all .2s;margin-bottom:7px}
.ditem.on{background:rgba(201,168,76,.1);border-color:var(--gold)}
.dtap{width:118px;height:118px;border-radius:50%;background:linear-gradient(135deg,var(--gold),#8a5e20);
  border:4px solid rgba(201,168,76,.4);font-size:2rem;display:flex;align-items:center;justify-content:center;
  margin:0 auto 15px;transition:transform .1s;animation:pulse 2.5s ease-in-out infinite}
.dtap:active{transform:scale(.91)}

/* â”€â”€ TOPICS â”€â”€ */
.topics{display:flex;flex-wrap:wrap;gap:6px;margin-top:11px}
.tpill{background:var(--gs);border:1px solid var(--border);border-radius:50px;
  padding:5px 12px;color:rgba(201,168,76,.7);font-size:.71rem;cursor:pointer;transition:all .2s}
.tpill:active{background:rgba(201,168,76,.18);color:var(--gold)}

/* â”€â”€ FLOAT â”€â”€ */
.float{position:fixed;bottom:80px;right:15px;z-index:200;display:flex;flex-direction:column;align-items:center;gap:3px}
.fbtn{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));
  border:2px solid rgba(201,168,76,.5);font-size:1.25rem;display:flex;align-items:center;justify-content:center;
  animation:pulse 2.5s ease-in-out infinite}
.flabel{font-size:.48rem;color:rgba(201,168,76,.5)}

/* â”€â”€ MODAL â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(3,12,12,.93);z-index:300;
  display:flex;align-items:center;justify-content:center;padding:16px;backdrop-filter:blur(10px)}
.mbox{background:linear-gradient(160deg,#0c2222,#0a2e2e);border:1px solid rgba(201,168,76,.28);
  border-radius:22px;padding:20px;max-width:580px;width:100%;max-height:85vh;overflow-y:auto}

/* â”€â”€ KEY NEEDED BANNER â”€â”€ */
.key-banner{background:rgba(201,168,76,.07);border:1px solid rgba(201,168,76,.25);
  border-radius:12px;padding:14px;margin-bottom:14px;text-align:center}
</style>
</head>
<body>

<!-- SETUP (API KEY) -->
<div id="setup">
  <div class="setup-box">
    <div class="setup-moon">ğŸŒ™</div>
    <div class="setup-title">Noor â€” Ù†ÙˆØ±</div>
    <div class="setup-arabic">ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø³Ù„Ø§Ù…ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</div>

    <div class="setup-why">
      <h3>Why a Gemini API Key?</h3>
      <ul>
        <li>Searches the <strong style="color:#e8c97a">entire Quran</strong> (6,236 Ayat) intelligently</li>
        <li>Searches <strong style="color:#e8c97a">50,000+ authentic Hadith</strong> in real time</li>
        <li>Understands emotion &amp; meaning â€” not just keywords</li>
        <li>Every result is <strong style="color:#e8c97a">unique and relevant</strong> â€” zero repetition</li>
        <li><strong style="color:#6fdf8f">100% FREE</strong> â€” Google gives free access</li>
      </ul>
    </div>

    <div style="font-size:.78rem;color:var(--text2);margin-bottom:12px;text-align:left;line-height:1.8">
      <span style="color:var(--gold);font-weight:700">How to get your FREE key:</span><br>
      1. Go to <a href="https://aistudio.google.com" target="_blank" class="setup-link">aistudio.google.com</a><br>
      2. Sign in with your Google account<br>
      3. Click <strong style="color:#e8c97a">"Get API Key"</strong> â†’ "Create API Key"<br>
      4. Copy and paste it below
    </div>

    <input class="setup-input" type="text" id="key-input" placeholder="Paste your Gemini API key hereâ€¦" autocomplete="off" autocorrect="off" spellcheck="false">
    <button class="setup-btn" id="key-save">âœ¨ Start Noor</button>
    <button class="setup-skip" id="key-skip">Skip â€” use limited offline mode</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="header">
    <div class="h-row">
      <div class="h-logo">
        <span class="h-moon">ğŸŒ™</span>
        <span class="h-name">Noor</span>
        <span class="h-arabic">Ù†ÙˆØ±</span>
      </div>
      <div class="h-actions">
        <button class="hbtn" id="key-status-btn">ğŸ”‘ Key</button>
        <button class="hbtn" id="settings-btn">âš™ï¸</button>
      </div>
    </div>
    <div class="h-sub">Real-Time Quran &amp; Hadith â€” AI-Powered Search</div>
  </div>
  <div class="content" id="content"></div>
  <div class="nav" id="nav"></div>
  <div class="float">
    <button class="fbtn" id="daily-btn">ğŸŒ…</button>
    <span class="flabel">Daily</span>
  </div>
  <div class="overlay" id="daily-modal" style="display:none">
    <div class="mbox">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
        <span class="sl">ğŸŒ… Today's Ayat</span>
        <button id="daily-close" style="background:var(--gs);border:1px solid var(--border);border-radius:8px;padding:4px 12px;color:rgba(201,168,76,.6);font-size:.78rem">âœ• Close</button>
      </div>
      <div id="daily-content"><div class="loader"><div class="spinner"></div></div></div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOOR v5.0 â€” How it works:
//
// QURAN SEARCH:
//   Step 1 â†’ Gemini reads the user's emotion/text
//   Step 2 â†’ Gemini picks the 3 BEST Surah:Ayah references from real Quran
//   Step 3 â†’ Al-Quran Cloud API fetches actual Arabic + English + Urdu text
//   Step 4 â†’ Gemini writes a personal insight for each result
//   Result â†’ Real Quran text, AI-understood relevance, never repeated
//
// HADITH SEARCH:
//   Step 1 â†’ Gemini reads the topic
//   Step 2 â†’ Gemini retrieves authentic Hadith from its Quran/Hadith knowledge
//   Step 3 â†’ Returns with book, narrator, Arabic, grading, explanation
//   Result â†’ Real authentic Hadith, varied every time
//
// WHY THIS WORKS:
//   Gemini was trained on the entire Quran and major Hadith collections.
//   It can accurately identify surah:ayah references and recall Hadith text.
//   We verify Arabic text via the open Quran API for 100% accuracy.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ STATIC DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var EMOTIONS = [
  {e:"ğŸ˜¢",l:"Sad",k:"sad"},{e:"ğŸ˜°",l:"Anxious",k:"anxious"},
  {e:"ğŸ¤²",l:"Grateful",k:"grateful"},{e:"ğŸŒ«ï¸",l:"Lost",k:"lost"},
  {e:"ğŸŒ…",l:"Hopeful",k:"hopeful"},{e:"ğŸ˜Ÿ",l:"Afraid",k:"afraid"},
  {e:"â˜®ï¸",l:"Peaceful",k:"peaceful"},{e:"ğŸ˜ ",l:"Angry",k:"angry"},
  {e:"ğŸ’”",l:"Heartbroken",k:"heartbroken"},{e:"ğŸ”",l:"Seeking Guidance",k:"seeking guidance"}
];

var TABS = [
  {id:"home",icon:"ğŸ ",label:"Home"},{id:"hadith",icon:"ğŸ“œ",label:"Hadith"},
  {id:"names",icon:"âœ¨",label:"Names"},{id:"prayer",icon:"ğŸ•Œ",label:"Prayer"},
  {id:"dhikr",icon:"ğŸ“¿",label:"Dhikr"},{id:"bookmarks",icon:"ğŸ”–",label:"Saved"}
];

var NAMES = [
  {n:1,ar:"Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ†Ù",tr:"Ar-Rahman",en:"The Most Gracious",b:"Recite for mercy and compassion in all affairs."},
  {n:2,ar:"Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù",tr:"Ar-Raheem",en:"The Most Merciful",b:"Recite for forgiveness and endless mercy."},
  {n:3,ar:"Ø§Ù„Ù’Ù…ÙÙ„ÙÙƒÙ",tr:"Al-Malik",en:"The King",b:"Recite 100x after Fajr for dignity and authority."},
  {n:4,ar:"Ø§Ù„Ù’Ù‚ÙØ¯ÙÙ‘ÙˆØ³Ù",tr:"Al-Quddus",en:"The Most Holy",b:"Recite to purify the heart from sin."},
  {n:5,ar:"Ø§Ù„Ø³ÙÙ‘Ù„Ø§ÙÙ…Ù",tr:"As-Salam",en:"The Source of Peace",b:"Recite for peace, safety and healing."},
  {n:6,ar:"Ø§Ù„Ù’Ù…ÙØ¤Ù’Ù…ÙÙ†Ù",tr:"Al-Mumin",en:"The Guardian of Faith",b:"Recite 631x for protection from fear."},
  {n:7,ar:"Ø§Ù„Ù’Ø¹ÙØ²ÙÙŠØ²Ù",tr:"Al-Aziz",en:"The Almighty",b:"Recite for strength and dignity in difficult times."},
  {n:8,ar:"Ø§Ù„Ù’Ø¬ÙØ¨ÙÙ‘Ø§Ø±Ù",tr:"Al-Jabbar",en:"The Compeller",b:"Recite to mend what is broken in your life."},
  {n:9,ar:"Ø§Ù„Ù’Ø®ÙØ§Ù„ÙÙ‚Ù",tr:"Al-Khaliq",en:"The Creator",b:"Recite when seeking new beginnings."},
  {n:10,ar:"Ø§Ù„Ù’ØºÙÙÙÙ‘Ø§Ø±Ù",tr:"Al-Ghaffar",en:"The Forgiving",b:"Recite abundantly between Sunnah and Fard."},
  {n:11,ar:"Ø§Ù„Ø±ÙÙ‘Ø²ÙÙ‘Ø§Ù‚Ù",tr:"Ar-Razzaq",en:"The Provider",b:"Recite for increase in sustenance and rizq."},
  {n:12,ar:"Ø§Ù„Ù’ÙÙØªÙÙ‘Ø§Ø­Ù",tr:"Al-Fattah",en:"The Opener",b:"Recite when doors seem closed."},
  {n:13,ar:"Ø§ÙÙ„Ù’Ø¹ÙÙ„ÙÙŠÙ…Ù",tr:"Al-Alim",en:"The All-Knowing",b:"Recite for knowledge, clarity and wisdom."},
  {n:14,ar:"Ø§Ù„Ù„ÙÙ‘Ø·ÙÙŠÙÙ",tr:"Al-Latif",en:"The Subtle One",b:"Recite 133x for hidden blessings and gentle relief."},
  {n:15,ar:"Ø§Ù„Ù’Ø­ÙÙƒÙÙŠÙ…Ù",tr:"Al-Hakim",en:"The Wise",b:"Recite for wisdom in important decisions."},
  {n:16,ar:"Ø§Ù„Ù’ÙˆÙØ¯ÙÙˆØ¯Ù",tr:"Al-Wadud",en:"The Loving",b:"Recite for love, harmony and reconciliation."},
  {n:17,ar:"Ø§Ù„Ø´ÙÙ‘ÙƒÙÙˆØ±Ù",tr:"Ash-Shakur",en:"The Appreciative",b:"Recite to multiply blessings through gratitude."},
  {n:18,ar:"Ø§Ù„ØµÙÙ‘Ù…ÙØ¯Ù",tr:"As-Samad",en:"The Eternal Refuge",b:"Recite when only Allah can help."},
  {n:19,ar:"Ø§Ù„Ù†ÙÙ‘ÙˆØ±Ù",tr:"An-Nur",en:"The Light",b:"Recite for enlightenment of the heart."},
  {n:20,ar:"Ø§Ù„Ù’Ù‡ÙØ§Ø¯ÙÙŠ",tr:"Al-Hadi",en:"The Guide",b:"Recite when lost and needing direction."},
  {n:21,ar:"Ø§Ù„ØªÙÙ‘ÙˆÙÙ‘Ø§Ø¨Ù",tr:"At-Tawwab",en:"The Acceptor of Repentance",b:"Recite abundantly during tawbah."},
  {n:22,ar:"Ø§Ù„Ø¹ÙÙÙÙˆÙÙ‘",tr:"Al-Afuww",en:"The Pardoner",b:"Recite in the last third of the night."},
  {n:23,ar:"Ø§Ù„Ù’Ø­ÙÙŠÙÙ‘",tr:"Al-Hayy",en:"The Ever-Living",b:"Recite for life, energy and health."},
  {n:24,ar:"Ø§Ù„Ù’Ù‚ÙÙŠÙÙ‘ÙˆÙ…Ù",tr:"Al-Qayyum",en:"The Self-Sustaining",b:"Recite with Al-Hayy for complete reliance."},
  {n:25,ar:"Ø§Ù„Ù’ØºÙÙ†ÙÙŠÙÙ‘",tr:"Al-Ghani",en:"The Self-Sufficient",b:"Recite to remove dependency on others."},
  {n:26,ar:"Ø§Ù„ØµÙÙ‘Ø¨ÙÙˆØ±Ù",tr:"As-Sabur",en:"The Patient",b:"Recite for patience during hardship."},
  {n:27,ar:"Ø§Ù„Ù’Ù…ÙØ¬ÙÙŠØ¨Ù",tr:"Al-Mujib",en:"The Responsive",b:"Recite when making dua â€” Allah always responds."},
  {n:28,ar:"Ø§Ù„Ù’ÙˆÙØ§Ø³ÙØ¹Ù",tr:"Al-Wasi",en:"The All-Encompassing",b:"Recite to remember Allah's mercy is boundless."},
  {n:29,ar:"Ø§Ù„Ù’ÙƒÙØ±ÙÙŠÙ…Ù",tr:"Al-Karim",en:"The Most Generous",b:"Recite for generosity and noble character."},
  {n:30,ar:"Ø§Ù„Ø±ÙÙ‘Ù‚ÙÙŠØ¨Ù",tr:"Ar-Raqib",en:"The Ever-Watchful",b:"Recite to feel Allah is always present."},
];

var DHIKR = [
  {ar:"Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",tr:"SubhanAllah",meaning:"Glory be to Allah",count:33,reward:"Plants a tree in Jannah"},
  {ar:"Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù",tr:"Alhamdulillah",meaning:"All praise be to Allah",count:33,reward:"Fills the scales of good deeds"},
  {ar:"Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙÙƒÙ’Ø¨ÙØ±Ù",tr:"Allahu Akbar",meaning:"Allah is the Greatest",count:33,reward:"Most beloved words to Allah"},
  {ar:"Ù„ÙØ§ Ø¥ÙÙ„ÙÙ‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø§Ù„Ù„ÙÙ‘Ù‡Ù",tr:"La ilaha illallah",meaning:"No god but Allah",count:100,reward:"Best of all dhikr"},
  {ar:"Ø£ÙØ³Ù’ØªÙØºÙ’ÙÙØ±Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",tr:"Astaghfirullah",meaning:"I seek forgiveness from Allah",count:100,reward:"Opens the doors of mercy"},
  {ar:"Ù„ÙØ§ Ø­ÙÙˆÙ’Ù„Ù ÙˆÙÙ„ÙØ§ Ù‚ÙÙˆÙÙ‘Ø©Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù",tr:"La hawla wala quwwata",meaning:"No power except with Allah",count:100,reward:"A treasure from the treasures of Jannah"},
];

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var S = {
  tab:"home",
  home:{query:"",emotion:"",loading:false,results:null,error:"",step:""},
  hadith:{query:"",loading:false,results:null,error:"",step:""},
  names:{search:"",selected:null},
  prayer:{input:"",loading:false,times:null,city:"",error:"",now:new Date()},
  dhikr:{idx:0,count:0,sessions:JSON.parse(localStorage.getItem("noor_dhikr")||"{}")},
};

var BM = {
  all:function(){return JSON.parse(localStorage.getItem("noor_bm")||"[]")},
  has:function(s,a){return BM.all().some(function(b){return String(b.s)===String(s)&&String(b.a)===String(a)})},
  add:function(x){var l=BM.all();if(!BM.has(x.s,x.a)){l.unshift(Object.assign({},x,{ts:Date.now()}));localStorage.setItem("noor_bm",JSON.stringify(l));}},
  rem:function(s,a){localStorage.setItem("noor_bm",JSON.stringify(BM.all().filter(function(b){return!(String(b.s)===String(s)&&String(b.a)===String(a))})))},
};

// â”€â”€ API KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getKey(){return localStorage.getItem("noor_gemini_key")||""}
function hasKey(){return getKey().length>10}
function updateKeyBtn(){
  var btn=document.getElementById("key-status-btn");
  if(btn) btn.className="hbtn "+(hasKey()?"key-ok":"key-no");
  if(btn) btn.textContent=hasKey()?"ğŸŸ¢ AI On":"ğŸ”´ No Key";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEMINI â€” the intelligence layer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var MODELS = ["gemini-1.5-flash","gemini-2.0-flash","gemini-1.5-pro","gemini-1.0-pro"];
var lastCall = 0;

function callGemini(prompt, expectJSON) {
  var key = getKey();
  if (!key) return Promise.reject(new Error("NO_KEY"));
  var now = Date.now();
  var wait = Math.max(0, 2500-(now-lastCall));
  return new Promise(function(res){setTimeout(res,wait)}).then(function(){
    lastCall = Date.now();
    var body = JSON.stringify({
      contents:[{parts:[{text:prompt}]}],
      generationConfig:{temperature:0.4,maxOutputTokens:2000}
    });
    // Try models in sequence
    var chain = Promise.reject(new Error("start"));
    MODELS.forEach(function(model){
      chain = chain.catch(function(e){
        if(e.message==="INVALID_KEY") return Promise.reject(e);
        var url="https://generativelanguage.googleapis.com/v1beta/models/"+model+":generateContent?key="+key;
        return fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:body})
          .then(function(r){
            if(r.status===401||r.status===403) return Promise.reject(new Error("INVALID_KEY"));
            if(r.status===429) return Promise.reject(new Error("RATE_LIMIT"));
            if(!r.ok) return Promise.reject(new Error("HTTP_"+r.status));
            return r.json();
          })
          .then(function(d){
            var t=d&&d.candidates&&d.candidates[0]&&d.candidates[0].content&&d.candidates[0].content.parts&&d.candidates[0].content.parts[0]&&d.candidates[0].content.parts[0].text;
            if(!t) return Promise.reject(new Error("NO_TEXT"));
            return t;
          });
      });
    });
    return chain;
  });
}

function parseJSON(raw, isArray) {
  var cleaned = raw.replace(/```json\s*/gi,"").replace(/```\s*/g,"").trim();
  var open = isArray?"[":"{", close = isArray?"]":"}";
  var s = cleaned.indexOf(open), e = cleaned.lastIndexOf(close);
  if(s===-1||e<=s) throw new Error("No JSON found");
  var str = cleaned.slice(s,e+1);
  // Fix trailing commas
  str = str.replace(/,(\s*[}\]])/g,"$1");
  return JSON.parse(str);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QURAN API â€” fetch real text for a surah:ayah
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fetchAyahText(surah, ayah) {
  // Fetch Arabic + English + Urdu in parallel
  var base = "https://api.alquran.cloud/v1/ayah/"+surah+":"+ayah;
  return Promise.all([
    fetch(base).then(function(r){return r.json()}).catch(function(){return null}),
    fetch(base+"/en.yusufali").then(function(r){return r.json()}).catch(function(){return null}),
    fetch(base+"/ur.jalandhry").then(function(r){return r.json()}).catch(function(){return null}),
  ]).then(function(res){
    var ar=res[0], en=res[1], ur=res[2];
    return {
      s: surah, a: ayah,
      sn: en&&en.data?en.data.surah.englishName:(ar&&ar.data?ar.data.surah.englishName:""),
      sa: ar&&ar.data?ar.data.surah.name:"",
      ar: ar&&ar.data?ar.data.text:"",
      en: en&&en.data?en.data.text:"",
      ur: ur&&ur.data?ur.data.text:"",
    };
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART QURAN SEARCH
// Flow: Gemini picks refs â†’ Quran API fetches real text â†’ Gemini adds insight
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function searchQuran(emotion, freeText) {
  var context = [];
  if(emotion) context.push("Emotion: "+emotion);
  if(freeText&&freeText.trim()) context.push("User wrote: "+freeText.trim());
  if(!context.length) context.push("General Islamic guidance");
  var userContext = context.join(". ");

  // Step 1: Ask Gemini for the BEST Quran references for this exact situation
  var refPrompt =
    "You are an Islamic scholar. A Muslim is reaching out with this situation:\n" +
    userContext + "\n\n" +
    "Select exactly 3 Quranic Ayat that are MOST relevant and comforting for this specific situation.\n" +
    "Choose from the ENTIRE Quran â€” not just well-known ones. Be precise and varied.\n" +
    "Respond ONLY with a JSON array of 3 objects. No explanation. No markdown.\n" +
    'Format: [{"surah":2,"ayah":286,"reason":"why this ayah is relevant in 1 sentence"},...]';

  var setStep = function(s){S.home.step=s;var el=document.getElementById("load-step");if(el)el.textContent=s;};

  setStep("Understanding your situationâ€¦");
  return callGemini(refPrompt, true)
    .then(function(raw){
      var refs = parseJSON(raw, true);
      setStep("Fetching real Ayat from Quran databaseâ€¦");
      // Step 2: Fetch actual text from Quran API for each reference
      return Promise.all(refs.map(function(ref){
        return fetchAyahText(ref.surah, ref.ayah)
          .then(function(ayat){
            return Object.assign({}, ayat, {_reason: ref.reason});
          });
      }));
    })
    .then(function(ayatList){
      setStep("Adding personalized insightsâ€¦");
      // Step 3: Ask Gemini to write a personal insight for each
      var insightPrompt =
        "A Muslim with this situation: " + userContext + "\n\n" +
        "Write a SHORT personal insight (2-3 sentences) for each of these Ayat, " +
        "explaining specifically why it applies to their situation. Be warm and direct.\n" +
        "Respond ONLY with a JSON array of 3 objects. No markdown.\n" +
        'Format: [{"surah":N,"ayah":N,"insight":"...","relevance":"one sentence why this is for them"},...]\n\n' +
        "Ayat: " + JSON.stringify(ayatList.map(function(a){return {surah:a.s,ayah:a.a,en:a.en}}));

      return callGemini(insightPrompt, true).then(function(raw){
        var insights = parseJSON(raw, true);
        // Merge insights into ayat
        return ayatList.map(function(a){
          var insight = insights.find(function(i){return i.surah===a.s&&i.ayah===a.a});
          return Object.assign({}, a, {
            tf: insight?insight.insight:"",
            rl: insight?insight.relevance:"",
          });
        });
      }).catch(function(){
        // Insights failed â€” return ayat without them (still valuable)
        return ayatList;
      });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SMART HADITH SEARCH
// Gemini retrieves authentic Hadith from its knowledge
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function searchHadith(query) {
  var prompt =
    "You are an Islamic scholar specializing in Hadith sciences.\n" +
    "Find 3 authentic Hadith about: " + query + "\n\n" +
    "Requirements:\n" +
    "- Must be from major collections: Bukhari, Muslim, Tirmidhi, Abu Dawud, Nasai, Ibn Majah\n" +
    "- Must include the Arabic text\n" +
    "- Must be accurate â€” only cite Hadith you are certain about\n" +
    "- Vary the collections (don't use same book twice)\n" +
    "- Include a clear explanation connecting it to the topic\n\n" +
    "Respond ONLY with a JSON array of 3 objects. No markdown. No extra text.\n" +
    'Format: [{"narrator":"Name (RA)","book":"Sahih Bukhari","book_ar":"ØµØ­ÙŠØ­ Ø§Ù„Ø¨Ø®Ø§Ø±ÙŠ","number":"123","grade":"Sahih","arabic":"...","english":"...","urdu":"...","explanation":"2-3 sentences explaining relevance"},...]';

  return callGemini(prompt, true).then(function(raw){
    return parseJSON(raw, true);
  }).then(function(hadith){
    // Normalize field names
    return hadith.map(function(h){
      return {
        n: h.narrator||h.n||"",
        b: h.book||h.b||"",
        ba: h.book_ar||h.ba||"",
        num: String(h.number||h.num||""),
        g: h.grade||h.g||"Sahih",
        ar: h.arabic||h.ar||"",
        en: h.english||h.en||"",
        ur: h.urdu||h.ur||"",
        ex: h.explanation||h.ex||"",
      };
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DAILY AYAT â€” AI-powered or API-based
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var dailyLoaded = false;
function openDaily(){
  document.getElementById("daily-modal").style.display="flex";
  if(!dailyLoaded) loadDaily();
}
function closeDaily(){document.getElementById("daily-modal").style.display="none";}

function loadDaily(){
  var today = new Date().toDateString();
  try{var c=JSON.parse(localStorage.getItem("noor_daily")||"null");if(c&&c.date===today){showDaily(c.ayat);return;}}catch(e){}

  var pool=[{s:94,a:6},{s:2,a:286},{s:13,a:28},{s:39,a:53},{s:93,a:5},
            {s:14,a:7},{s:12,a:87},{s:48,a:4},{s:2,a:152},{s:65,a:3},
            {s:3,a:139},{s:89,a:27},{s:9,a:51},{s:7,a:199},{s:3,a:134}];
  var pick = pool[new Date().getDate()%pool.length];

  // Try AI first for a unique daily selection
  if(hasKey()){
    var dailyPrompt =
      "Today is "+today+". Pick ONE uplifting Quran Ayat for a Muslim to start their day with.\n" +
      "Choose something meaningful, not overly common. Provide Arabic, English, Urdu, and a 2-sentence reflection.\n" +
      "Respond ONLY with a JSON object: {\"surah\":N,\"ayah\":N,\"surah_name\":\"...\",\"surah_name_ar\":\"...\",\"arabic\":\"...\",\"english\":\"...\",\"urdu\":\"...\",\"reflection\":\"...\"}";

    callGemini(dailyPrompt, false).then(function(raw){
      var d = parseJSON(raw, false);
      var ayat = {s:d.surah,a:d.ayah,sn:d.surah_name||"",sa:d.surah_name_ar||"",
                  ar:d.arabic||"",en:d.english||"",ur:d.urdu||"",tf:d.reflection||""};
      localStorage.setItem("noor_daily",JSON.stringify({date:today,ayat:ayat}));
      showDaily(ayat);
    }).catch(function(){
      fetchAndShowDaily(pick, today);
    });
  } else {
    fetchAndShowDaily(pick, today);
  }
}

function fetchAndShowDaily(pick, today){
  fetchAyahText(pick.s, pick.a).then(function(ayat){
    localStorage.setItem("noor_daily",JSON.stringify({date:today,ayat:ayat}));
    showDaily(ayat);
  }).catch(function(){
    showDaily({s:94,a:6,sn:"Ash-Sharh",sa:"Ø§Ù„Ø´ÙÙ‘Ø±Ù’Ø­",
      ar:"Ø¥ÙÙ†ÙÙ‘ Ù…ÙØ¹Ù Ø§Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Ø§",en:"Indeed, with hardship will be ease.",ur:"Ø¨Û’ Ø´Ú© ØªÚ©Ù„ÛŒÙ Ú©Û’ Ø³Ø§ØªÚ¾ Ø¢Ø³Ø§Ù†ÛŒ ÛÛ’"});
  });
}

function showDaily(a){
  dailyLoaded=true;
  document.getElementById("daily-content").innerHTML = a ? ayatCard(a) :
    "<div style='color:var(--text3);text-align:center;padding:20px'>Could not load. Check connection.</div>";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ayatCard(a){
  var bm=BM.has(a.s,a.a);
  return '<div class="acard fade">'+
    '<div class="a-meta">'+
      '<div class="a-ref">'+(a.sa?'<span style="font-family:Amiri,serif;font-size:1rem">'+a.sa+'</span> Â· ':'')+
        (a.sn||"")+' '+a.s+':'+a.a+'</div>'+
      '<div class="a-btns">'+
        '<button class="abtn" onclick="playAudio('+a.s+','+a.a+',this)">â–¶</button>'+
        '<button class="abtn'+(bm?' on':'')+'" id="bm_'+a.s+'_'+a.a+'" onclick="toggleBM('+a.s+','+a.a+')">'+(bm?'ğŸ”–':'Save')+'</button>'+
      '</div>'+
    '</div>'+
    (a.ar?'<div class="a-ar">'+a.ar+'<div style="font-size:.6rem;direction:ltr;text-align:left;margin-top:5px;color:rgba(201,168,76,.28);font-family:Inter,sans-serif">['+a.s+':'+a.a+']</div></div>':'')+
    '<div class="a-tr">'+
      (a.ur?'<div class="tr-row"><div class="lang-badge">UR</div><div style="flex:1"><div class="lbl">Ø§Ø±Ø¯Ùˆ</div><div class="ar-txt">'+a.ur+'</div></div></div>':'')+
      '<div class="tr-row"><div class="lang-badge">EN</div><div style="flex:1"><div class="lbl">English</div><div class="en-txt">'+a.en+'</div></div></div>'+
    '</div>'+
    (a.tf||a.rl?
      '<div class="a-insight">'+
        (a.tf?'<div class="insight-text">'+a.tf+'</div>':'')+
        (a.rl?'<div class="relevance-box">'+a.rl+'</div>':'')+
      '</div>'
    :'')+
  '</div>';
}

function hadithCard(h){
  return '<div class="hcard">'+
    '<div class="section-head">'+
      '<div style="font-size:.82rem;color:#e8c97a;font-weight:600">'+
        (h.ba?'<span style="font-family:Amiri,serif">'+h.ba+'</span> Â· ':'')+
        (h.b||'')+(h.num?' #'+h.num:'')+
        (h.n?'<br><span style="font-size:.73rem;color:rgba(201,168,76,.5)">'+h.n+'</span>':'')+
      '</div>'+
      '<span class="grade-badge">'+(h.g||"Sahih")+'</span>'+
    '</div>'+
    (h.ar?'<div class="h-ar">'+h.ar+'</div>':'')+
    '<div class="h-body">'+
      (h.ur?'<div class="tr-row"><div class="lang-badge">UR</div><div style="flex:1"><div class="lbl">Ø§Ø±Ø¯Ùˆ</div><div class="ar-txt">'+h.ur+'</div></div></div>':'')+
      '<div class="tr-row"><div class="lang-badge">EN</div><div style="flex:1"><div class="lbl">English</div><div class="en-txt">'+(h.en||h.english||"")+'</div></div></div>'+
    '</div>'+
    (h.ex?'<div class="h-exp"><div class="sl" style="margin-bottom:7px">Explanation</div><div style="font-size:.86rem;line-height:1.75;color:var(--text2)">'+h.ex+'</div></div>':'')+
  '</div>';
}

function loaderHTML(text, stepId){
  return '<div class="loader">'+
    '<div class="spinner"></div>'+
    '<div style="color:var(--text3);font-size:.84rem">'+(text||"Searchingâ€¦")+'</div>'+
    '<div class="load-arabic">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù</div>'+
    (stepId?'<div class="load-steps" id="'+stepId+'"></div>':'')+
  '</div>';
}

function noKeyBanner(){
  return '<div class="key-banner">'+
    '<div style="font-size:1.8rem;margin-bottom:8px">ğŸ”‘</div>'+
    '<div style="font-weight:700;color:#e8c97a;margin-bottom:6px">Add Gemini API Key for Real Search</div>'+
    '<div style="font-size:.8rem;color:var(--text2);margin-bottom:12px;line-height:1.7">'+
      'With a free Gemini key, Noor searches <strong>all 6,236 Ayat</strong> and <strong>50,000+ Hadith</strong> in real time â€” unique results every search.'+
    '</div>'+
    '<button onclick="showKeySetup()" style="background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:10px;padding:10px 20px;color:#1a1208;font-weight:700;font-size:.85rem">Add Free Key â†’</button>'+
  '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB RENDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHome(){
  var h=S.home;
  return '<div class="card">'+
    '<div class="sl" style="margin-bottom:13px">ğŸ” Search the Holy Quran â€” Real Time</div>'+
    '<div class="egrid">'+EMOTIONS.map(function(e){
      return '<button class="ebtn'+(h.emotion===e.k?' on':'')+'" onclick="toggleEmotion(\''+e.k+'\')">'+e.e+' '+e.l+'</button>';
    }).join('')+'</div>'+
    '<textarea id="si" rows="3" placeholder="Describe what you are going through in your own wordsâ€¦&#10;e.g. &quot;I lost my job and feel hopeless&quot; or &quot;stress about exams&quot;" style="resize:none"></textarea>'+
    '<button class="sbtn" '+(h.loading?'disabled':'')+' onclick="doSearch()">'+
      (h.loading?'â³ Searchingâ€¦':'ğŸ” Find Quran Guidance')+
    '</button>'+
  '</div>'+
  (h.loading?loaderHTML("Searching all 6,236 Ayatâ€¦","load-step"):'')+ 
  (h.error?'<div class="err">'+h.error+'</div>':'')+
  (!h.loading&&h.results&&h.results.length?
    '<div class="source-tag"><div class="source-dot"></div><span>Live from Al-Quran Cloud Â· '+h.results.length+' Ayat from 6,236 Â· AI-selected for your situation</span></div>'+
    h.results.map(ayatCard).join('')
  :'')+
  (!h.loading&&!h.results&&!h.error?
    '<div class="empty">'+
      '<div style="font-size:3.5rem;margin-bottom:14px">ğŸ“–</div>'+
      '<div style="font-size:.95rem;margin-bottom:10px">Select an emotion or describe your situation above</div>'+
      '<div style="font-size:.78rem;color:var(--text3)">Gemini AI searches all 6,236 Ayat and fetches real Arabic text for you</div>'+
      '<div style="font-family:Amiri,serif;font-size:1.6rem;color:rgba(201,168,76,.18);margin-top:16px">Ø§ÙÙ‚Ù’Ø±ÙØ£Ù’ Ø¨ÙØ§Ø³Ù’Ù…Ù Ø±ÙØ¨ÙÙ‘ÙƒÙ</div>'+
    '</div>'
  :'')+
  (!hasKey()?noKeyBanner():'');
}

function renderHadith(){
  var h=S.hadith;
  var topics=["patience","prayer","kindness","anger","honesty","parents","charity","knowledge","forgiveness","brotherhood","gratitude","guidance","repentance","trust in Allah","hardship","death","marriage","health","dua","jealousy"];
  return '<div class="card">'+
    '<div class="sl" style="margin-bottom:13px">ğŸ“œ Authentic Hadith Search â€” Real Time</div>'+
    '<div style="font-size:.73rem;color:var(--text3);margin-bottom:12px">Searches across Bukhari Â· Muslim Â· Tirmidhi Â· Abu Dawud Â· and more</div>'+
    '<div style="display:flex;gap:9px">'+
      '<input type="text" id="hi" placeholder="Search any topic â€” e.g. patience with hardshipâ€¦">'+
      '<button onclick="doHadith()" style="background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:12px;padding:11px 15px;color:#1a1208;font-weight:700;font-size:.87rem;white-space:nowrap">'+(h.loading?'â³':'ğŸ”')+'</button>'+
    '</div>'+
    '<div class="topics">'+topics.map(function(t){return '<button class="tpill" onclick="quickH(\''+t+'\')">'+t+'</button>'}).join('')+'</div>'+
  '</div>'+
  (h.loading?loaderHTML("Searching authentic Hadithâ€¦","had-step"):'')+ 
  (h.error?'<div class="err">'+h.error+'</div>':'')+
  (!h.loading&&h.results&&h.results.length?
    '<div class="source-tag"><div class="source-dot"></div><span>AI-retrieved from Bukhari Â· Muslim Â· Tirmidhi â€” unique every search</span></div>'+
    h.results.map(hadithCard).join('')
  :'')+
  (!h.loading&&!h.results&&!h.error?
    '<div class="empty"><div style="font-size:3rem;margin-bottom:12px">ğŸ“œ</div>'+
      '<div>Type a topic or tap a keyword above</div>'+
      '<div style="font-size:.78rem;color:var(--text3);margin-top:8px">Searches Bukhari, Muslim, Tirmidhi and more â€” real Hadith, never repeated</div>'+
    '</div>'
  :'')+
  (!hasKey()?noKeyBanner():'');
}

function renderNames(){
  var n=S.names, q=n.search.toLowerCase();
  var filtered=NAMES.filter(function(x){return x.tr.toLowerCase().indexOf(q)!==-1||x.en.toLowerCase().indexOf(q)!==-1||x.ar.indexOf(n.search)!==-1});
  return '<div class="card">'+
    '<div class="sl" style="margin-bottom:13px">âœ¨ 99 Names of Allah â€” Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø³Ù†Ù‰</div>'+
    '<input type="text" id="ns" placeholder="Search by name or meaningâ€¦">'+
  '</div>'+
  (n.selected?
    '<div class="n-detail">'+
      '<div style="font-family:Amiri,serif;font-size:3.5rem;color:#e8c97a;margin-bottom:10px">'+n.selected.ar+'</div>'+
      '<div style="font-size:1.3rem;color:#e8c97a;font-weight:700">'+n.selected.tr+'</div>'+
      '<div style="font-size:.9rem;color:var(--text2);margin-top:4px">'+n.selected.en+'</div>'+
      '<div style="font-size:.84rem;color:rgba(201,168,76,.75);margin-top:15px;font-style:italic;line-height:1.7">'+n.selected.b+'</div>'+
      '<button onclick="S.names.selected=null;renderContent()" style="margin-top:13px;background:var(--gs);border:1px solid var(--border);border-radius:8px;padding:6px 16px;color:var(--gold);font-size:.8rem">âœ• Close</button>'+
    '</div>':'')+
  '<div class="ngrid">'+filtered.map(function(x){
    return '<div class="ncard" onclick="S.names.selected=NAMES.find(function(n){return n.n==='+x.n+'});render()">'+
      '<div style="font-size:.56rem;color:var(--text3);margin-bottom:2px">'+x.n+'</div>'+
      '<div style="font-family:Amiri,serif;font-size:1.4rem;color:#e8c97a;margin-bottom:3px">'+x.ar+'</div>'+
      '<div style="font-size:.65rem;color:var(--gold);font-weight:600">'+x.tr+'</div>'+
      '<div style="font-size:.59rem;color:var(--text3);margin-top:2px">'+x.en+'</div>'+
    '</div>';
  }).join('')+'</div>';
}

function renderPrayer(){
  var p=S.prayer,now=p.now;
  var nm=now.getHours()*60+now.getMinutes();
  var icons={Fajr:"ğŸŒ„",Sunrise:"ğŸŒ…",Dhuhr:"â˜€ï¸",Asr:"ğŸŒ¤ï¸",Maghrib:"ğŸŒ‡",Isha:"ğŸŒ™"};
  var next=null;
  if(p.times){Object.keys(p.times).forEach(function(name){var pts=p.times[name].split(":").map(Number);if(!next&&pts[0]*60+pts[1]>nm)next=name;});if(!next)next="Fajr";}
  return '<div class="card">'+
    '<div class="sl" style="margin-bottom:13px">ğŸ•Œ Prayer Times</div>'+
    '<div style="font-size:2rem;font-weight:700;color:#e8c97a;text-align:center;letter-spacing:2px" id="clock">'+now.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit"})+'</div>'+
    '<div style="font-size:.75rem;color:var(--text3);text-align:center;margin-top:3px">'+now.toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})+'</div>'+
    '<div style="display:flex;gap:9px;margin-top:15px">'+
      '<input type="text" id="ci" placeholder="City â€” e.g. Karachi, Lahore, Dubai">'+
      '<button onclick="fetchPrayer()" style="background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:12px;padding:11px 13px;color:#1a1208;font-weight:700;font-size:.8rem;white-space:nowrap">'+(p.loading?'â³':'Get Times')+'</button>'+
    '</div>'+
    (p.error?'<div style="color:rgba(255,180,180,.7);font-size:.8rem;margin-top:7px">âš ï¸ '+p.error+'</div>':'')+
  '</div>'+
  (p.times?
    '<div class="card">'+
      '<div style="text-align:center;font-weight:600;color:#e8c97a;margin-bottom:13px">ğŸ“ '+p.city+'</div>'+
      (next?'<div style="background:rgba(201,168,76,.1);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;margin-bottom:13px">'+
        '<div style="font-size:.58rem;text-transform:uppercase;letter-spacing:2px;color:rgba(201,168,76,.4);margin-bottom:3px">Next Prayer</div>'+
        '<div style="font-size:1.1rem;color:#e8c97a;font-weight:700">'+(icons[next]||"ğŸ•Œ")+' '+next+' â€” '+p.times[next]+'</div></div>':'')+
      Object.keys(p.times).map(function(name){
        var isNext=next===name;
        return '<div class="pr-row '+(isNext?'pr-next':'pr-rest')+'">'+
          '<div style="color:'+(isNext?'#e8c97a':'var(--text2)')+'">'+(icons[name]||'ğŸ•Œ')+' '+name+'</div>'+
          '<div style="font-weight:700;color:'+(isNext?'#e8c97a':'var(--text2)')+'">'+p.times[name]+'</div></div>';
      }).join('')+
    '</div>'
  :'<div class="empty"><div style="font-size:3rem;margin-bottom:12px">ğŸ•Œ</div><div>Enter your city for prayer times</div></div>');
}

function renderDhikr(){
  var d=S.dhikr,sel=DHIKR[d.idx];
  var pct=Math.min(d.count/sel.count*100,100);
  var r=62,circ=2*Math.PI*r;
  var today=new Date().toDateString();
  var todayStats=DHIKR.filter(function(dk){return (d.sessions[today+"_"+dk.tr]||0)>0});
  return '<div class="card" style="margin-bottom:14px">'+
    '<div class="sl" style="margin-bottom:12px">ğŸ“¿ Choose Dhikr</div>'+
    DHIKR.map(function(dk,i){
      return '<div class="ditem'+(d.idx===i?' on':'')+'" onclick="setDhikr('+i+')">'+
        '<div><div style="font-family:Amiri,serif;font-size:1.1rem;color:'+(d.idx===i?'#e8c97a':'var(--text2)')+'">'+dk.ar+'</div>'+
        '<div style="font-size:.7rem;color:rgba(201,168,76,.4);margin-top:2px">'+dk.tr+' Â· '+dk.meaning+'</div></div>'+
        '<div style="font-size:.67rem;color:rgba(201,168,76,.3)">Ã—'+dk.count+'</div></div>';
    }).join('')+
  '</div>'+
  '<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:22px;text-align:center">'+
    '<div style="font-family:Amiri,serif;font-size:2rem;color:#e8c97a;margin-bottom:4px">'+sel.ar+'</div>'+
    '<div style="font-size:.8rem;color:rgba(201,168,76,.5);margin-bottom:18px">'+sel.meaning+'</div>'+
    '<div style="position:relative;width:150px;height:150px;margin:0 auto 16px">'+
      '<svg width="150" height="150" style="transform:rotate(-90deg)">'+
        '<circle cx="75" cy="75" r="'+r+'" fill="none" stroke="rgba(201,168,76,.12)" stroke-width="9"/>'+
        '<circle cx="75" cy="75" r="'+r+'" fill="none" stroke="#c9a84c" stroke-width="9" stroke-linecap="round" stroke-dasharray="'+circ+'" stroke-dashoffset="'+(circ*(1-pct/100))+'" style="transition:stroke-dashoffset .3s"/>'+
      '</svg>'+
      '<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center">'+
        '<div style="font-size:2.8rem;font-weight:800;color:#e8c97a;line-height:1">'+d.count+'</div>'+
        '<div style="font-size:.67rem;color:rgba(201,168,76,.4);margin-top:3px">of '+sel.count+'</div>'+
      '</div>'+
    '</div>'+
    '<button class="dtap" onclick="tapDhikr()">ğŸ“¿</button>'+
    '<div style="font-size:.77rem;color:rgba(201,168,76,.55);font-style:italic;margin-bottom:13px">'+sel.reward+'</div>'+
    '<button onclick="S.dhikr.count=0;renderContent()" style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:6px 18px;color:var(--text3);font-size:.8rem">â†º Reset</button>'+
    (todayStats.length?'<div style="margin-top:16px;border-top:1px solid var(--border2);padding-top:13px">'+
      '<div class="sl" style="margin-bottom:9px">Today</div>'+
      '<div style="display:flex;justify-content:center;gap:15px;flex-wrap:wrap">'+
        todayStats.map(function(dk){var c=d.sessions[today+"_"+dk.tr]||0;return '<div style="text-align:center"><div style="font-size:.75rem;color:var(--gold);font-weight:700">'+c+'</div><div style="font-size:.59rem;color:var(--text3)">'+dk.tr+'</div></div>'}).join('')+
      '</div></div>':'')+
  '</div>';
}

function renderBookmarks(){
  var bm=BM.all();
  if(!bm.length) return '<div class="empty"><div style="font-size:3.5rem;margin-bottom:13px">ğŸ”–</div><div>No saved Ayat yet</div><div style="font-size:.78rem;margin-top:8px;color:var(--text3)">Tap Save on any Ayat to keep it here</div></div>';
  return '<div class="sl" style="margin-bottom:15px">ğŸ”– Saved Ayat ('+bm.length+')</div>'+
    bm.map(function(a){
      return ayatCard(a)+
        '<button onclick="BM.rem('+a.s+','+a.a+');renderContent()" style="display:block;margin:-7px auto 15px;background:rgba(180,50,50,.1);border:1px solid rgba(180,50,50,.22);border-radius:8px;padding:5px 13px;color:rgba(255,140,140,.6);font-size:.75rem">ğŸ—‘ Remove</button>';
    }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNav(){
  document.getElementById("nav").innerHTML=TABS.map(function(t){
    return '<button class="nb'+(S.tab===t.id?' active':'')+'" onclick="switchTab(\''+t.id+'\')">'+
      '<span class="nb-icon">'+t.icon+'</span>'+
      '<span class="nb-label">'+t.label+'</span>'+
      '<div class="nb-dot"></div></button>';
  }).join('');
}

function renderContent(){
  var el=document.getElementById("content");
  if(!el) return;
  switch(S.tab){
    case"home":      el.innerHTML=renderHome();      bindHome();      break;
    case"hadith":    el.innerHTML=renderHadith();    bindHadith();    break;
    case"names":     el.innerHTML=renderNames();     bindNames();     break;
    case"prayer":    el.innerHTML=renderPrayer();    bindPrayer();    break;
    case"dhikr":     el.innerHTML=renderDhikr();                      break;
    case"bookmarks": el.innerHTML=renderBookmarks();                   break;
  }
}

function render(){renderNav();renderContent();updateKeyBtn();}

// â”€â”€ BINDINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function bindHome(){
  var si=document.getElementById("si"); if(!si) return;
  si.value=S.home.query;
  si.addEventListener("input",function(e){S.home.query=e.target.value;});
  si.addEventListener("keydown",function(e){if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();doSearch();}});
}
function bindHadith(){
  var hi=document.getElementById("hi"); if(!hi) return;
  hi.value=S.hadith.query;
  hi.addEventListener("input",function(e){S.hadith.query=e.target.value;});
  hi.addEventListener("keydown",function(e){if(e.key==="Enter")doHadith();});
}
function bindNames(){
  var ns=document.getElementById("ns"); if(!ns) return;
  ns.value=S.names.search;
  ns.addEventListener("input",function(e){
    S.names.search=e.target.value;
    var c=ns.selectionStart; renderContent();
    var n2=document.getElementById("ns"); if(n2){n2.focus();n2.setSelectionRange(c,c);}
  });
}
function bindPrayer(){
  var ci=document.getElementById("ci"); if(!ci) return;
  ci.value=S.prayer.input;
  ci.addEventListener("input",function(e){S.prayer.input=e.target.value;});
  ci.addEventListener("keydown",function(e){if(e.key==="Enter")fetchPrayer();});
}

// â”€â”€ SYNC ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(t){S.tab=t;render();window.scrollTo(0,0);}
function toggleEmotion(k){S.home.emotion=(S.home.emotion===k?"":k);renderContent();}
function quickH(t){S.hadith.query=t;render();doHadith();}
function setDhikr(i){S.dhikr.idx=i;S.dhikr.count=0;renderContent();}

function tapDhikr(){
  var d=S.dhikr,sel=DHIKR[d.idx];
  d.count++;
  if(d.count===sel.count)setTimeout(function(){alert("MashaAllah! ğŸ‰\n"+sel.count+"Ã— "+sel.tr+" completed!\n\n"+sel.reward);},100);
  var today=new Date().toDateString(),key=today+"_"+sel.tr;
  d.sessions[key]=(d.sessions[key]||0)+1;
  localStorage.setItem("noor_dhikr",JSON.stringify(d.sessions));
  renderContent();
}

function toggleBM(s,a){
  var found=(S.home.results||[]).find(function(x){return x.s===s&&x.a===a})||BM.all().find(function(x){return x.s===s&&x.a===a})||{s:s,a:a,sn:"",sa:"",ar:"",en:"",ur:""};
  if(BM.has(s,a))BM.rem(s,a);else BM.add(found);
  render();
}

var curAudio=null;
function playAudio(s,a,btn){
  if(curAudio){curAudio.pause();curAudio=null;document.querySelectorAll(".abtn.playing").forEach(function(b){b.textContent="â–¶";b.classList.remove("playing");});}
  curAudio=new Audio("https://cdn.islamic.network/quran/audio/128/ar.alafasy/"+String(s).padStart(3,"0")+String(a).padStart(3,"0")+".mp3");
  btn.textContent="â¹";btn.classList.add("playing");
  curAudio.onended=function(){btn.textContent="â–¶";btn.classList.remove("playing");curAudio=null;};
  curAudio.onerror=function(){btn.textContent="â–¶";btn.classList.remove("playing");curAudio=null;};
  curAudio.play().catch(function(){btn.textContent="â–¶";});
}

// â”€â”€ ASYNC ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doSearch(){
  var h=S.home;
  if(!h.query.trim()&&!h.emotion) return;
  if(!hasKey()){showKeySetup();return;}
  h.loading=true;h.error="";h.results=null;h.step="";
  render();

  searchQuran(h.emotion,h.query)
    .then(function(ayat){
      S.home.loading=false;S.home.results=ayat;S.home.error="";
      render();
    })
    .catch(function(e){
      S.home.loading=false;
      if(e.message==="INVALID_KEY")S.home.error="Invalid API key. Get a free key at aistudio.google.com";
      else if(e.message==="NO_KEY")S.home.error="No API key. Tap 'Add Free Key' below.";
      else S.home.error="Search failed. Check your connection and try again.";
      render();
    });
}

function doHadith(){
  var h=S.hadith;
  if(!h.query.trim()) return;
  if(!hasKey()){showKeySetup();return;}
  h.loading=true;h.error="";h.results=null;
  render();

  searchHadith(h.query)
    .then(function(hadith){
      S.hadith.loading=false;S.hadith.results=hadith;S.hadith.error="";
      render();
    })
    .catch(function(e){
      S.hadith.loading=false;
      if(e.message==="INVALID_KEY")S.hadith.error="Invalid API key. Get a free key at aistudio.google.com";
      else S.hadith.error="Search failed. Check your connection and try again.";
      render();
    });
}

function fetchPrayer(){
  var p=S.prayer; if(!p.input.trim()) return;
  p.loading=true;p.error="";render();
  var d=new Date();
  fetch("https://api.aladhan.com/v1/timingsByCity?city="+encodeURIComponent(p.input)+"&country=PK&method=1&date="+d.getDate()+"-"+(d.getMonth()+1)+"-"+d.getFullYear())
    .then(function(r){return r.json()})
    .then(function(data){
      if(data.code!==200)throw new Error("not found");
      var t=data.data.timings;
      p.times={Fajr:t.Fajr,Sunrise:t.Sunrise,Dhuhr:t.Dhuhr,Asr:t.Asr,Maghrib:t.Maghrib,Isha:t.Isha};
      p.city=p.input;p.error="";
    })
    .catch(function(){p.error="City not found. Try: Karachi, Lahore, Islamabad, Dubai";})
    .then(function(){p.loading=false;render();});
}

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showSettings(){
  var choice=prompt("âš™ï¸ Noor Settings\n\n1 â€” Change API Key\n2 â€” See Intro Again\n3 â€” Clear All Data\n4 â€” Cancel\n\nType a number:");
  if(choice==="1") showKeySetup();
  else if(choice==="2"){localStorage.removeItem("noor_onboarded");location.reload();}
  else if(choice==="3"){if(confirm("Clear all saved data?")){{localStorage.clear();location.reload();}}}
}

function showKeySetup(){
  var cur=getKey();
  var k=prompt(
    "ğŸ”‘ Gemini API Key â€” 100% Free\n\n"+
    "1. Go to: aistudio.google.com\n"+
    "2. Sign in with Google\n"+
    "3. Click 'Get API Key' â†’ 'Create API Key'\n"+
    "4. Copy and paste below\n\n"+
    "Current: "+(cur?"****"+cur.slice(-4):"Not set")+"\n\nPaste your key:"
  );
  if(k&&k.trim().length>10){
    localStorage.setItem("noor_gemini_key",k.trim());
    alert("âœ… Key saved! Real-time Quran and Hadith search is now enabled.");
    render();
  }
}

// â”€â”€ SETUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSetup(){
  document.getElementById("key-save").onclick=function(){
    var k=document.getElementById("key-input").value.trim();
    if(k.length>10){
      localStorage.setItem("noor_gemini_key",k);
      localStorage.setItem("noor_onboarded","1");
      document.getElementById("setup").style.display="none";
      document.getElementById("app").classList.add("show");
      render();
    } else {
      document.getElementById("key-input").style.borderColor="rgba(255,100,100,.6)";
      setTimeout(function(){document.getElementById("key-input").style.borderColor="";},2000);
    }
  };
  document.getElementById("key-skip").onclick=function(){
    localStorage.setItem("noor_onboarded","1");
    document.getElementById("setup").style.display="none";
    document.getElementById("app").classList.add("show");
    render();
  };
}

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(function(){
  S.prayer.now=new Date();
  if(S.tab==="prayer"){var cl=document.getElementById("clock");if(cl)cl.textContent=S.prayer.now.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",second:"2-digit"});}
},1000);

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener("load",function(){
  initSetup();
  document.getElementById("settings-btn").onclick=showSettings;
  document.getElementById("key-status-btn").onclick=showKeySetup;
  document.getElementById("daily-btn").onclick=openDaily;
  document.getElementById("daily-close").onclick=closeDaily;
  document.getElementById("daily-modal").onclick=function(e){if(e.target===this)closeDaily();};

  // If already onboarded, go straight to app
  if(localStorage.getItem("noor_onboarded")){
    document.getElementById("setup").style.display="none";
    document.getElementById("app").classList.add("show");
    render();
  }
  // Otherwise setup screen is already visible
});
</script>
</body>
</html>
